var easy_support_videos=easy_support_videos||{}
!function(e){"use strict"
var s
easy_support_videos.hasOwnProperty("Backbone")||(easy_support_videos.Backbone={Views:{},instances:{views:[]}}),easy_support_videos.hasOwnProperty("actions")||(easy_support_videos.actions={insert:"easy_support_videos_insert",edit:"easy_support_videos_edit","delete":"easy_support_videos_delete",save_option:"easy_support_videos_save_option",contextual_videos_set_global_video:"easy_support_videos_contextual_videos_set_global_video"}),easy_support_videos.hasOwnProperty("spinner")||(easy_support_videos.spinner={active_css_classes:"is-active easy-support-videos-is-active easy-support-videos-spinner-is-active"}),easy_support_videos.hasOwnProperty("message")||(easy_support_videos.message={active_css_classes:"is-active easy-support-videos-is-active easy-support-videos-message-is-active"}),easy_support_videos.Backbone.Views.Easy_Support_Videos=wp.Backbone.View.extend({el:".easy-support-videos-wrap",template:wp.template("easy-support-videos-video"),videos_el_selector:"#easy-support-videos-videos",current_value_data_key:"easy-support-videos-current-value",message_timer:-1,message_timer_delay:5e3,current_message_timer_delay:0,events:{"click #easy-support-videos-pro-preview-button":"maybePreviewVideos","click #easy-support-videos-insert-video-button":"insertVideo","keypress #easy-support-videos-insert-video-url":"insertVideo","input .easy-support-videos-video-title":"editVideo","input .easy-support-videos-video-excerpt":"editVideoExcerpt","click .easy-support-videos-video-delete":"deleteVideo","esv-ajax-processing":function(e,s,t){this.ajax.events.esvAjaxProcessing(e,s,t)},"click .easy-support-videos-status-message-close":"hideMessage","input #easy-support-videos-option-sidebar-message":"editSidebarMessage","change .easy-support-videos-contextual-videos-set-global-video":"setContextualVideosGlobalVideo"},ajax:{data:{easy_support_videos:1},events:{esvAjaxProcessing:function(e,t,a){var i=s.$el.find("#easy-support-videos-preview-button"),o=s.$el.find("#easy-support-videos-video-preview-spinner")
t?(o.addClass(easy_support_videos.spinner.active_css_classes),i.addClass("disabled easy-support-videos-disabled")):(o.removeClass(easy_support_videos.spinner.active_css_classes),i.removeClass("disabled easy-support-videos-disabled"))}},queue:{processing:!1,current_item:{},current_request:!1,current_request_count:0,items:[],addItem:function(e){var t=this,a=!1
return this.current_request?(a=this.canAbortRequest(e),a?(s.ajax.queue.items.push(e),this.current_request.abort(),this.process(!0)):(_.each(s.ajax.queue.items,function(i,o){a=t.canAbortRequest(e,i,!0),a&&s.ajax.queue.items.splice(o,1)}),s.ajax.queue.items.push(e))):(_.each(s.ajax.queue.items,function(i,o){a=t.canAbortRequest(e,i,!0),a&&s.ajax.queue.items.splice(o,1)}),s.ajax.queue.items.push(e)),this},canAbortRequest:function(e,s,t){var a=!1
return s=s||this.current_item,t=t||!1,t?_.isObject(e.abort)&&_.isObject(s.abort)&&e.action===s.action&&(a=!0,_.find(s.abort,function(s,t){return e.abort.hasOwnProperty(t)&&s===e.abort[t]?void 0:(a=!1,!0)})):e.abort&&!_.isEmpty(s)&&e.action===s.action&&(a=!0,_.isObject(e.abort)&&_.find(e.abort,function(e,t){return s.data.hasOwnProperty(t)&&e===s.data[t]?void 0:(a=!1,!0)})),a},process:function(e){return e=e||!1,e||!s.ajax.queue.processing&&0!==s.ajax.queue.items.length?e&&0===s.ajax.queue.items.length&&0===this.current_request_count?(this.current_request=!1,this.current_item={},s.ajax.setActiveSpinnersInactive(),s.ajax.queue.processing&&this.setProcessingStatusFlag(!1),void s.$el.trigger("esv-ajax-processing",[!1,e])):(s.$el.trigger("esv-ajax-processing",[!0,e]),this.current_request=!1,this.setProcessingStatusFlag(!0),s.ajax.queue.current_item=s.ajax.queue.items.shift(),this.processCurrentItem(),this):(0===s.ajax.queue.items.length&&0===this.current_request_count&&(this.current_request=!1,this.current_item={},s.ajax.setActiveSpinnersInactive(),s.ajax.queue.processing&&this.setProcessingStatusFlag(!1)),void s.$el.trigger("esv-ajax-processing",[!1,e]))},processCurrentItem:function(){var e=s.ajax.queue.current_item
return this.current_request=wp.ajax.post(e.action,e.data).done(e.success).fail(e.fail),this.current_request_count++,this},setProcessingStatusFlag:function(e){return s.ajax.queue.processing=e?!0:!1,this},finishProcessingRequest:function(){return this.current_request_count--,this}},setupData:function(t,a,i){return a=a||!1,i=i||!1,s.$el.trigger("esv-ajax-setup-data",[t,a,i]),e.extend(t,this.data)},displayResponseStatusMessage:function(e){(e.message||e.error&&!_.isFunction(e.error))&&s.showMessage(e.message?e.message:e.error)},setActiveSpinnerInactive:function(t){var a,i=".easy-support-videos-spinner"
switch(i+='[data-type="'+t.type+'"]',t.type){case"option":t.option_group&&(i+='[data-option-group="'+t.option_group+'"]'),i+='[data-option-name="'+t.option_name+'"]'
break
case"video":"insert"!==t.event&&(i+='[data-post-id="'+t.post_id+'"]'),i+='[data-event="'+t.event+'"]'}a=e(i),!a.length&&s.ajax.queue.current_item.spinner&&(a=s.ajax.queue.current_item.spinner),a.removeClass(easy_support_videos.spinner.active_css_classes)},setActiveSpinnersInactive:function(){var e="."+easy_support_videos.spinner.active_css_classes.split(" ").join(".")
s.$el.find(".easy-support-videos-spinner"+e).removeClass(easy_support_videos.spinner.active_css_classes)},success:{all:function(e){s.ajax.queue.finishProcessingRequest(),s.ajax.setActiveSpinnerInactive(e),s.ajax.displayResponseStatusMessage(e),s.$el.trigger("esv-ajax-success-all",e),s.ajax.queue.setProcessingStatusFlag(!1).process()},insertVideo:function(e){var t=s.$el.find(s.videos_el_selector),a=t.find(".easy-support-video"),i=s.$el.find("#easy-support-videos-insert-video-url")
s.$el.addClass("easy-support-videos-has-videos"),a.length?a.first().before(s.template(e)):t.append(s.template(e)).find("#easy-support-videos-no-videos-message").remove(),i.val(""),t.fitVids(),s.$el.trigger("esv-ajax-success-insert-video",e),s.ajax.success.all(e)},editVideo:function(e){s.$el.find('.easy-support-video[data-post-id="'+e.post_id+'"] .easy-support-videos-video-title').data(s.current_value_data_key,e.title),s.$el.trigger("esv-ajax-success-edit-video",e),s.ajax.success.all(e)},deleteVideo:function(e){var t,a=s.$el.find(s.videos_el_selector)
s.$el.find('.easy-support-video[data-post-id="'+e.post_id+'"]').remove(),t=a.find(".easy-support-video"),t.length||s.$el.removeClass("easy-support-videos-has-videos"),s.$el.trigger("esv-ajax-success-delete-video",e),s.ajax.success.all(e)},editSidebarMessage:function(e){s.$el.find("#easy-support-videos-option-sidebar-message").data(s.current_value_data_key,e.value),s.$el.trigger("esv-ajax-success-edit-sidebar-message",e),s.ajax.success.all(e)},setContextualVideosGlobalVideo:function(t){var a=t.contextual_videos.set_global_video,i=s.$el.find(".easy-support-videos-contextual-videos-set-global-video-context-toggle"),o=i.filter('[data-post-id="'+t.post_id+'"]'),r=i.not(o)
a&&r.each(function(){var s=e(this),t=s.find('input[type="checkbox"]')
t.prop("checked")&&t.prop("checked",!1)}),s.$el.trigger("esv-ajax-success-edit-contextual-videos-set-global-video",t),s.ajax.success.all(t)}},fail:{all:function(e){s.ajax.queue.finishProcessingRequest(),e.statusText&&"abort"===e.statusText||s.ajax.setActiveSpinnerInactive(e),s.ajax.displayResponseStatusMessage(e),s.$el.trigger("esv-ajax-fail-all",e),s.ajax.queue.setProcessingStatusFlag(e.statusText&&"abort"===e.statusText).process()},insertVideo:function(e){s.$el.trigger("esv-ajax-fail-insert-video",e),s.ajax.fail.all(e)},editVideo:function(e){s.$el.trigger("esv-ajax-fail-edit-video",e),s.ajax.fail.all(e)},deleteVideo:function(e){s.$el.trigger("esv-ajax-fail-delete-video",e),s.ajax.fail.all(e)},setContextualVideosGlobalVideo:function(e){s.$el.trigger("esv-ajax-fail-edit-contextual-videos-global-video",e),s.ajax.fail.all(e)}}},initialize:function(){var s=this,t=this.$el.find("#easy-support-videos-option-sidebar-message")
_.bindAll(this,"maybePreviewVideos","insertVideo","editVideo","deleteVideo","hideMessage","editSidebarMessage","editVideoExcerpt","setContextualVideosGlobalVideo"),easy_support_videos.current_user_can.edit&&(this.$el.find(".easy-support-videos-video-title").each(function(){var t=e(this)
t.data(s.current_value_data_key,t.val())}),t.data(this.current_value_data_key,t.val()))},maybePreviewVideos:function(s){var t=e(s.currentTarget)
t.hasClass("disabled")&&s.preventDefault()},insertVideo:function(e){if("keypress"!==e.type||13===e.which){var s=this.$el.find("#easy-support-videos-insert-video-url"),t=s.val(),a=this.$el.find("#easy-support-videos-insert-video-spinner"),i=this.ajax.setupData({nonce:this.$el.find("#easy_support_videos_nonce_insert").val(),url:t},easy_support_videos.actions.insert)
if(e.preventDefault(),!t)return void this.showMessage(easy_support_videos.l10n.video_url_empty)
a.addClass(easy_support_videos.spinner.active_css_classes),this.ajax.queue.addItem({action:easy_support_videos.actions.insert,data:i,success:this.ajax.success.insertVideo,fail:this.ajax.fail.insertVideo,spinner:a}).process()}},editVideo:_.debounce(function(s,t,a){t=t||e(s.currentTarget),a=a||!1
var i=t.hasClass("easy-support-videos-video-title")||t.hasClass("easy-support-videos-video-excerpt")?t.parents(".easy-support-video"):t,o=t.hasClass("easy-support-videos-video-title")?t:i.find(".easy-support-videos-video-title"),r=t.hasClass("easy-support-videos-video-excerpt")?t:i.find(".easy-support-videos-video-excerpt"),n=o.val(),d=o.data(this.current_value_data_key),p=i.find(".easy-support-videos-video-id"),u=p.val(),c=i.find(".easy-support-videos-video-title-spinner"),v=this.ajax.setupData({nonce:this.$el.find("#easy_support_videos_nonce_edit").val(),post_id:u,title:n,post_excerpt:r.val()},easy_support_videos.actions.edit,t)
if(s.preventDefault(),a||n!==d){if(!n)return o.val(d),void this.showMessage(easy_support_videos.l10n.video_title_empty)
c.addClass(easy_support_videos.spinner.active_css_classes),this.ajax.queue.addItem({action:easy_support_videos.actions.edit,data:v,success:this.ajax.success.editVideo,fail:this.ajax.fail.editVideo,spinner:c,abort:{post_id:v.post_id}}).process()}},500),deleteVideo:function(s,t){t=t||e(s.currentTarget)
var a=t.parent().find(".easy-support-videos-video-id"),i=a.val(),o=t.parents(".easy-support-video"),r=t.parents(".easy-support-video").find(".easy-support-videos-video-spinner"),n=this.ajax.setupData({nonce:this.$el.find("#easy_support_videos_nonce_delete").val(),post_id:i},easy_support_videos.actions["delete"],t)
s.preventDefault(),r.add(o).addClass(easy_support_videos.spinner.active_css_classes),this.ajax.queue.addItem({action:easy_support_videos.actions["delete"],data:n,success:this.ajax.success.deleteVideo,fail:this.ajax.fail.deleteVideo,spinner:r}).process()},showMessage:function(e){var s=this,t=this.message_timer_delay,a=this.$el.find("#easy-support-videos-status-message"),i=a.find(".easy-support-videos-message");-1!==this.message_timer&&(clearTimeout(this.message_timer),this.current_message_timer_delay=0),i.html(e),a.addClass(easy_support_videos.message.active_css_classes),t+=e.length>160?this.message_timer_delay:0,t+=e.length>20&&e.length<=160?5e3*((e.length-20)/140):0,this.current_message_timer_delay=t,this.$el.trigger("esv-show-message",[this]),this.message_timer=setTimeout(function(){s.hideMessage(!1),s.current_message_timer_delay=0},this.current_message_timer_delay)},hideMessage:function(e){var s=e&&!_.isEmpty(e),t=this.$el.find("#easy-support-videos-status-message")
s&&e.preventDefault(),t.removeClass(easy_support_videos.message.active_css_classes),clearTimeout(this.message_timer)},editSidebarMessage:_.debounce(function(s,t){t=t||e(s.currentTarget)
var a=t.val(),i=t.data(this.current_value_data_key),o=t.parents(".easy-support-videos-sidebar-item-message"),r=o.find("#easy-support-videos-sidebar-message-option-name"),n=r.val(),d=o.find("#easy-support-videos-sidebar-message-option-group"),p=d.val(),u=o.find("#easy-support-videos-video-sidebar-message-spinner"),c=this.ajax.setupData({nonce:this.$el.find("#easy_support_videos_nonce_save_option").val(),option_name:n,option_group:p,value:a},easy_support_videos.actions.save_option,t)
s.preventDefault(),a!==i&&(u.addClass(easy_support_videos.spinner.active_css_classes),this.ajax.queue.addItem({action:easy_support_videos.actions.save_option,data:c,success:this.ajax.success.editSidebarMessage,fail:this.ajax.fail.all,spinner:u,abort:{option_name:c.option_name,option_group:c.option_group}}).process())},500),editVideoExcerpt:function(s){var t=e(s.currentTarget),a=t.val().length,i=t.parents(".easy-support-video"),o=i.find(".easy-support-videos-video-excerpt-current-character-count")
o.text(a),this.editVideo(s,!1,!0)},setContextualVideosGlobalVideo:function(s,t){t=t||e(s.currentTarget)
var a=t.hasClass("easy-support-videos-contextual-videos-set-global-video")?t:t.find(".easy-support-videos-contextual-videos-set-global-video"),i=t.hasClass("easy-support-videos-contextual-videos-set-global-video")?t.parents(".easy-support-video"):t,o=i.find(".easy-support-videos-video-id"),r=o.val(),n=i.find(".easy-support-videos-video-title-spinner"),d=this.ajax.setupData({nonce:this.$el.find("#easy_support_videos_nonce_edit").val(),post_id:r,set_global_video:a.prop("checked")},easy_support_videos.actions.contextual_videos_set_global_video,t)
n.addClass(easy_support_videos.spinner.active_css_classes),this.ajax.queue.addItem({action:easy_support_videos.actions.contextual_videos_set_global_video,data:d,success:this.ajax.success.setContextualVideosGlobalVideo,fail:this.ajax.fail.setContextualVideosGlobalVideo,spinner:n,abort:{post_id:d.post_id}}).process()}}),e(function(){s=new easy_support_videos.Backbone.Views.Easy_Support_Videos,easy_support_videos.Backbone.instances.views.easy_support_videos=s,e(s.videos_el_selector).fitVids()})}(jQuery)
